<html>
  <head>
    <title>Sinatra::Synchrony</title>
    <link rel="stylesheet" href="bootstrap-1.3.0.min.css">
    <link rel="stylesheet" href="screen.css">

    <link href="google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="jquery-1.5.2.min.js"></script>
    <script type="text/javascript" src="google-code-prettify/prettify.js"></script>
    <script src="bootstrap-scrollspy.js"></script>
  <body onload="prettyPrint()">

    <div class="topbar" data-scrollspy="scrollspy">
      <div class="topbar-inner">
        <div class="container">
          <a class="brand" href="#">Sinatra::Synchrony</a>
          <ul class="nav">
            <li class="active"><a href="#about">About</a></li>
            <li><a href="#how-it-works">How it Works</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#benchmarks">Benchmarks</a></li>
            <li><a href="#geoloqi">Geoloqi</a></li>
            <li><a href="#further-reading">Further Reading</a></li>
            <li><a href="#caveats">Caveats</a></li>
            <li><a href="#source-code">Source Code</a></li>
          </ul>
        </div>
      </div>
    </div>


    <header class="jumbotron masthead" id="overview">
      <div class="inner">
        <div class="container">

          <div style="float: left">
            <h1>Sinatra::Synchrony</h1>
            <p class="lead">Fast, highly concurrent web applications with no callbacks!</p>
          </div>
          <div style="float: right">
            <img src="sinatra-synchrony.png" width="140">
          </div>
          <div style="clear: both"></div>
        </div>
      </div>
    </header>


    <div class="container info">
      <section id="about">
        <div class="page-header">
          <h1>About <small></small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <p>Sinatra::Synchrony is a small extension for Sinatra that (when used properly) improves the concurrency of your web application processes. Powered by <a href="https://github.com/eventmachine/eventmachine">EventMachine</a> and <a href="https://github.com/igrigorik/em-synchrony">EM-Synchrony</a>, it increases the number of clients your application can serve per process when you have a lot of traffic and slow IO calls (like HTTP calls to external APIs). Because it uses <a href="http://www.ruby-doc.org/core-1.9/classes/Fiber.html">Fibers</a> internally to handle blocking IO, no callback gymnastics are required! Just develop as if you were writing a normal Sinatra web application, use non-blocking libraries (see below) and you're all set.</p>

            <p>This project was initially introduced at the <a href="http://pdxruby.org">Portland Ruby Brigade</a>. The <a href="http://www.slideshare.net/KyleDrake/fast-concurrent-ruby-web-applications-with-em-and-emsynchrony">original slideshow is available online</a>. Recently, I've been telling people to use threads instead of reactor patterns, and I think you should not use this unless you absolutely have to (see <a href="#caveats">Caveats</a>).
          </div>
        </div>
      </section>
    </div>


    <div class="container">
      <section id="how-it-works">
        <div class="page-header">
          <h1>How It Works<small></small></h1>
        </div>
        <div class="row">
          <div class="span-16">

            <ul>
              <li>Loads EventMachine and EM-Synchrony. Requires app server with EventMachine and Ruby 1.9 support (<a href="http://code.macournoyer.com/thin">Thin</a>, <a href="http://rainbows.rubyforge.org">Rainbows!</a>, <a href="http://www.engineyard.com">Engine Yard</a>, <a href="http://heroku.com">Heroku</a>). It should also work on <a href="http://jruby.org">JRuby</a> (with JRUBY_OPTS="--1.9").</li>
              <li>Inserts the <a href="https://github.com/mperham/rack-fiber_pool">Rack::FiberPool</a> middleware, which automatically provides a Fiber for each incoming request, allowing EM-Synchrony to work.</li>
              <li>Adds <a href="https://github.com/igrigorik/em-http-request">em-http-request</a>, which you can use with EM::Synchrony to do concurrent HTTP calls to APIs! Or if you'd rather use a different client, it can patch TCPSocket via EM-Synchrony. Any software that uses this (such as an HTTP Client that uses Net::HTTP) can run without blocking IO. No HTTPS support yet, so you should use em-http-request (directly or with <a href="https://github.com/technoweenie/faraday">Faraday</a>).</li>
              <li>Patches Rack::Test so that it runs your tests within an EventMachine. Just test the same way you did before and it should just work.</li>
              <li>Patches Resolv via <a href="https://github.com/mperham/em-resolv-replace">em-resolv-replace</a>, enabling non-blocking DNS lookups magically, the way <a href="db.jpg">David Bowie</a> would want it.</li>
            </ul>
          </div>
        </div>
      </section>
    </div>


    <div class="container">
      <section id="installation">
        <div class="page-header">
          <h1>Installation <small></small></h1>
        </div>
        <div class="row">
          <div class="span16">
            <p>Install the gem:</p>

            <pre class="prettyprint lang-rb">gem install sinatra-synchrony</pre>

            <p>Register with Sinatra <b>at the top, before any other middleware or plugins are loaded:</b></p>
            <pre class="prettyprint lang-rb">
require 'sinatra/base'
require 'sinatra/synchrony'

class App < Sinatra::Base
  register Sinatra::Synchrony
end</pre>

            <p>If you are developing with a classic style app, just require the gem and it will automatically load:</p>

            <pre class="prettyprint lang-rb">
require 'sinatra'
require 'sinatra/synchrony'

get '/' do
  'Sinatra::Synchrony is loaded automatically in classic mode, nothing needed'
end
</pre>
          </div>
        </div>
      </section>
    </div>


    <div class="container">
      <section id="benchmarks">
        <div class="page-header">
          <h1>Benchmarks <small>Ruby <b>scales</b>.</small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <p>Despite enabling synchronous programming without callbacks, there is no performance hit to your application! All the performance benefits you expect from Thin/Rainbows and EventMachine are still there:</p>

            <pre class="prettyprint lang-rb">
class App < Sinatra::Base
  register Sinatra::Synchrony
  get '/' do
    'Hello World!'
  end
end
</pre>
            <p>Benchmarked with rackup -s thin:</p>
            <pre>
$ ab -c 50 -n 2000 http://127.0.0.1:9292/
...
Requests per second:    <b>3102.30</b> [#/sec] (mean)
Time per request:       <b>16.117</b> [ms] (mean)
Time per request:       <b>0.322</b> [ms] (mean, across all concurrent requests)

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.1      0       1
Processing:     5   16   7.7     13      38
Waiting:        3   13   7.0     10      35
Total:          6   16   7.7     13      38
</pre>

            <p>Let's try a simple blocking IO example to prove it works. 100 hits to google.com:</p>

            <pre class="prettyprint lang-rb">
require 'sinatra'
require 'sinatra/synchrony'
require 'rest-client'
require 'faraday'
Faraday.default_adapter = :em_synchrony

get '/' do
  Faraday.get 'http://google.com'
end
</pre>

            <pre>
$ ab -c 100 -n 100 http://127.0.0.1:9292/
...
Time taken for tests:   0.256 seconds
</pre>
            <p>For a perspective, this operation took <b>33 seconds</b> without this extension in thin.</b>

          </div>
        </div>
      </section>
    </div>


    <div class="container">
      <section id="geoloqi">
        <div class="page-header">
          <h1>Geoloqi <small></small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <p>This gem was designed to help us develop faster games and internal applications for <a href="http://geoloqi.com">Geoloqi</a>: a private, real-time mobile and web platform for securely sharing location data. We wanted to share with you how we deal with concurrency issues, and also make it easy to utilize this for our other projects. One of these projects is our recently released <a href="http://github.com/geoloqi/geoloqi-ruby">Geoloqi ruby adapter</a>, which utilizes Faraday and sinatra-synchrony to provide massive concurrency with almost no changes required to your code. Geoloqi is production ready right now, and we have a lot of major features and enhancements coming very soon.</p>
          </div>
        </div>
      </section>
    </div>


    <div class="container">
      <section id="further-reading">
        <div class="page-header">
          <h1>Further Reading <small>Get educated about how this all works.</small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <ul>
              <li><a href="http://rubylearning.com/blog/2010/10/01/an-introduction-to-eventmachine-and-how-to-avoid-callback-spaghetti">An introduction to eventmachine, and how to avoid callback spaghetti</a></li>
              <li><a href="http://www.igvita.com/2010/03/22/untangling-evented-code-with-ruby-fibers">Untangling Evented Code with Ruby Fibers</a></li>
              <li><a href="http://www.rubyinside.com/fibers-eventmachine-rack-performance-gains-3395.html">Ruby 1.9 Fibers + EventMachine for Big Ruby Webapp Performance Gains</a></li>
              <li><a href="http://www.igvita.com/2008/05/27/ruby-eventmachine-the-speed-demon">EventMachine - the Speed Demon</a></li>
              <li><a href="http://www.igvita.com/2009/05/13/fibers-cooperative-scheduling-in-ruby">Fibers & Cooperative Scheduling in Ruby</a></li>
              <li><a href="http://vimeo.com/10849958">Scalable ruby processing with EventMachine</a></li>
              <li><a href="http://rubysource.com/understanding-concurrent-programming-with-ruby-goliath">Understanding Concurrent Programming With Ruby's Goliath</a></li>
              <li><a href="http://www.unlimitednovelty.com/2010/08/multithreaded-rails-is-generally-better.html">Multithreaded Rails is generally better than Async Rails, and Rainbows is cooler than Node</a>  <small>(a fair minded critique of Reactor patterns. We're not anti-threads. We're pro-choice. <a href="http://al3x.net/2010/07/27/node.html">See Al3x's amazing blog post discussing this</a>.)</small></li>
            </ul>
          </div>
        </div>
      </section>
    </div>
    
    
    
    
    <div class="container">
      <section id="caveats">
        <div class="page-header">
          <h1>Caveats <small>and a few other thoughts.</small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <p>This extension does not provide non-blocking IO drivers for everything. Right now the focus is to improve the performance of our ruby applications by enabling cooperative scheduling without resorting to callbacks. You don't have to make everything non-blocking to speed up applications with this approach, which is the important thing to understand. For example, if your database access blocks and is under ten milliseconds, it's not as bad as a blocking API call to an external web site that takes a few seconds.</p>

            <p>There are numerous non-blocking IO drivers available for EventMachine. Check out the <a href="https://github.com/eventmachine/eventmachine/wiki/Protocol-Implementations">Protocol Implementations</a> page on the <a href="https://github.com/eventmachine/eventmachine/wiki">EventMachine GitHub Wiki</a> for a full list. I would personally like to see plug-and-play drivers implemented for the major three ORMs (ActiveRecord, DataMapper, Sequel). There are solutions for direct access though. For example, <a href="https://github.com/brianmario/mysql2">Mysql2</a> has excellent support for EventMachine, and I believe there are solutions for PostgreSQL as well. Learning how to do Fiber wrapping will empower you to understand how to make any async driver support this.</p>

            <p>Please also keep in mind that MRI Ruby 1.9.2 (YARV) does have an internal mechanism for running some IO requests in a non-blocking manner similar to this <b>as long as you're using GIL threads and are not using EventMachine (and this includes any usage of Thin)</b>. Dig through the source code for <i>rb_thread_blocking_region</i> if you're interested in exploring this further. If you're using Ruby 1.8, you should seriously consider switching to 1.9 YARV (1.8 also does this, but 1.9 is far better at it). I have an awesome <a href="https://gist.github.com/1498932">configuration script</a> for <a href="http://rainbows.rubyforge.org">Rainbows</a> which complements this approach with a thread pool. I also have a <a href="https://gist.github.com/2120107">config script for Rainbows and EventMachine</a>.</p>

            <p>So why is sinatra-synchrony useful if Ruby doesn't block on IO? Well, turning off the thread overhead can provide a very strong performance boost for IO work. So I would describe this as a tool for squeezing every last bit out of your web applications. And if you code it right, it's easy to switch back to GIL threads (or something with real threads like <a href="http://rubini.us">Rubinius 2.0</a> or <a href="http://jruby.org">JRuby</a>). The important thing in any programming environment is to have options. Here is an option for you. Use it wisely.</p>
          </div>
        </div>
      </section>
    </div>


    <div class="container last">
      <section id="source-code">
        <div class="page-header">
          <h1>Source Code <small></small></h1>
        </div>
        <div class="row">
          <div class="span-16">
            <p><a href="http://github.com/kyledrake/sinatra-synchrony" class="btn large primary">Fork me on Github!</a></p>
          </div>
        </div>
      </section>
    </div>
    
    <div class="container">
    <div class="row">
      <div class="span-16">
        <img src="db.jpg">
      </div>
    </div>
  </div>
    

    <footer class="footer">
      <div class="container">
        <p class="pull-right"><a href="#">Back to top</a></p>
        <p></p>
      </div>

    </footer>
  </body>
</html>
